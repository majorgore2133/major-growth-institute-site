<script>
// Firebase setup
const firebaseConfig = {
  apiKey:"AIzaSyAkaLgL4UDwVrKXK3RbWsDqwuhK2C7L49k",
  authDomain:"majorgrowthportal.firebaseapp.com",
  projectId:"majorgrowthportal",
  storageBucket:"majorgrowthportal.firebasestorage.app",
  messagingSenderId:"741963712787",
  appId:"1:741963712787:web:dbb9fb191cdae414b0f2e6",
  measurementId:"G-7NGDY9DYCW"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();

// --- Auth session guard
auth.onAuthStateChanged(u => {
  if(!u){ location.href="app.html"; return; }
  document.getElementById('who').textContent = "Signed in: " + (u.displayName || u.email);
});
document.getElementById('logout').onclick = () => auth.signOut().then(() => location.href="app.html");

// --- Tab switching (fix)
const tabs = document.querySelectorAll('.tab');
function selectTab(name){
  tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  ['overview','analyzer','reports','progress','support'].forEach(id => {
    const panel = document.getElementById('panel-' + id);
    if (panel) panel.style.display = (id === name ? (id === 'analyzer' ? 'block' : 'grid') : 'none');
  });
}
tabs.forEach(t => t.onclick = () => selectTab(t.dataset.tab));
selectTab('overview'); // show overview by default

// --- Reports / Lender Proxy
const PROXY = "https://majorgrowthproxy.laxfreaked.workers.dev";
const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DC","DE","FL","GA","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY"];

function loadStates(){
  const sel=document.getElementById('stateSel'); 
  if(!sel) return;
  sel.innerHTML="";
  STATES.forEach(s=>{
    const o=document.createElement('option');
    o.value=s; o.textContent=s; sel.appendChild(o);
  });
  sel.value="TX";
}
async function detectLocation(){
  try{
    const r=await fetch("https://ipapi.co/json/");
    const j=await r.json();
    const state=(j.region_code||"").toUpperCase();
    if(STATES.includes(state)) document.getElementById('stateSel').value=state;
  }catch(e){ alert("Could not detect location."); }
}
async function fetchLenders(){
  const state=document.getElementById('stateSel').value;
  const el=document.getElementById('lenders');
  el.innerHTML="Loading lenders…";
  try{
    const resp=await fetch(`${PROXY}/?state=${state}`);
    const data=await resp.json();
    if(!Array.isArray(data)||data.length===0){
      el.innerHTML="No lenders found or failed to load data.";
      return;
    }
    el.innerHTML=data.slice(0,40).map(x=>`
      <div class="pill" style="padding:8px;border-bottom:1px solid #ddd">
        <strong>${x.name}</strong> – ${x.city||"Unknown"} (${x.assets||"N/A"})
      </div>
    `).join("");
  }catch(err){
    console.error(err);
    el.innerHTML="Error fetching lender list.";
  }
}
loadStates();
</script>
